use std::{ops::Deref, sync::Arc};

/// The index of an actor in the VVM.
pub type Address = u32;

/// Addresses of important root services.
pub const PERM_ADDR: Address = 1;
pub const ALLOCATOR_ADDR: Address = 2;
pub const LOGGER_ADDR: Address = 3;

/// Addresses of implementations of important root services
pub const ALLOCATOR_IMPL_ADDR: Address = 4;

/// Supplied to message bindings created by with_bindings to capture the
/// value generated by the handling actor.
pub struct Callback<T>(Arc<Box<dyn FnOnce(T) + Send + Sync>>);

impl<T> Callback<T> {
	pub fn new(cb: impl FnOnce(T) + Send + Sync + 'static) -> Self {
		Self(Arc::new(Box::new(cb)))
	}
}

impl<T> AsRef<dyn FnOnce(T) + Send + Sync> for Callback<T> {
	fn as_ref(&self) -> &(dyn FnOnce(T) + Send + Sync + 'static) {
		(*self.0).as_ref()
	}
}

impl<T> Deref for Callback<T> {
	type Target = dyn FnOnce(T) + Send + Sync;

	fn deref(&self) -> &Self::Target {
		self.as_ref()
	}
}
